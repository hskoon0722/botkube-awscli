name: Deploy Botkube plugins to GitHub Pages

on:
  push:
    tags: ["*"]

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read   # deploy-pages@v4가 필요로 함

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Build plugins (snapshot)
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: build --clean --snapshot

      - name: Generate plugins index.yaml
        run: |
          set -euo pipefail
          # 안전하게 owner/repo 에서 repo 이름만 추출
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          BASE="https://${{ github.repository_owner }}.github.io/${REPO_NAME}"
          echo "URL BASE: $BASE"
          ls -l ./dist || true

          # v1.14.0은 replace 문제 있으니 latest 사용
          go run github.com/kubeshop/botkube/hack@latest \
            -binaries-path "./dist" \
            -url-base-path "$BASE" \
            > plugins-index.yaml

          echo "----- GENERATED INDEX -----"
          cat plugins-index.yaml | sed -n '1,200p'

      - name: Prepare site files
        run: |
          mkdir -p public
          cp -f dist/executor_* public/ || true
          cp -f plugins-index.yaml public/
          cat > public/index.html <<'HTML'
          <html><body><h1>Botkube Plugins</h1>
          <p>See <a href="./plugins-index.yaml">plugins-index.yaml</a></p>
          </body></html>
          HTML

      # v3 필요 (v1/v2는 내부적으로 upload-artifact v3를 써서 차단됨)
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
